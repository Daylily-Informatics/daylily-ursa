---
Region: us-west-2  #us-west-2
Image:
  Os: ubuntu2204
HeadNode:
  InstanceType: r7i.2xlarge #r7i.2xlarge
  Networking:
    ElasticIp: true
    SubnetId: subnet-0e9acb65aba5a0330  # subnet-018d25d2f208a83a2
  DisableSimultaneousMultithreading: false
  Ssh:
    KeyName: lsmc-omics-us-west-2  # must be ed25519 for ubuntu
    AllowedIps: "0.0.0.0/0" # SET THIS TO YOUR DESIRED FILTER
  Dcv:
    Enabled: false
  LocalStorage:
    RootVolume:  # ~$0.05/hr
      Size: 421
      VolumeType: gp3
      DeleteOnTermination: true
    EphemeralVolume:
      MountDir: /head_root
  CustomActions:
    OnNodeConfigured:
      Script: s3://lsmc-dayoa-omics-analysis-us-west-2/cluster_boot_config/post_install_ubuntu_combined.sh # head and each compute can have different scripts if desired
      Args:
      - us-west-2
      - lsmc-dayoa-omics-analysis-us-west-2
      - na
      - na
  Iam:
    S3Access:
    - BucketName: lsmc-dayoa-omics-analysis-us-west-2
      EnableWriteAccess: false
    AdditionalIamPolicies:
    - Policy: arn:aws:iam::108782052779:policy/pclusterTagsAndBudget
    - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
Scheduling:
  Scheduler: slurm
  SlurmSettings:
    EnableMemoryBasedScheduling: false
    ScaledownIdletime: 5
    Dns:
      DisableManagedDns: false
    QueueUpdateStrategy: DRAIN
  SlurmQueues:
  - Name: i8
    CapacityType: SPOT
    AllocationStrategy: price-capacity-optimized
    ComputeResources:
    - Name: r7gb64
      Instances:
      - InstanceType: r7i.2xlarge
      MinCount: 0
      MaxCount: 1
      SpotPrice: 4.3645 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    - Name: r6gb64
      Instances:
      - InstanceType: r6i.2xlarge
      MinCount: 0
      MaxCount: 1
      SpotPrice: 4.3645 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    Networking:
      SubnetIds:
      - subnet-087a4872d0c34e642
    CustomActions:
      OnNodeConfigured:
        Script: s3://lsmc-dayoa-omics-analysis-us-west-2/cluster_boot_config/post_install_ubuntu_combined.sh
        Args:
        - us-west-2
        - lsmc-dayoa-omics-analysis-us-west-2
        - na
        - na
    Iam:
      S3Access:
      - BucketName: lsmc-dayoa-omics-analysis-us-west-2
        EnableWriteAccess: false
      AdditionalIamPolicies:
      - Policy: arn:aws:iam::108782052779:policy/pclusterTagsAndBudget
      - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  - Name: i128
    CapacityType: SPOT
    AllocationStrategy: price-capacity-optimized
    ComputeResources:
    - Name: c6gb256
      Instances:
      - InstanceType: c6i.metal
      - InstanceType: c6i.32xlarge
      MinCount: 0
      MaxCount: 8
      SpotPrice: 6.4899 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    - Name: m6gb512
      Instances:
      - InstanceType: m6i.32xlarge
      - InstanceType: m6i.metal
      MinCount: 0
      MaxCount: 8
      SpotPrice: 6.4899 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    - Name: r6gb1024r6
      Instances:
      - InstanceType: r6i.metal
      - InstanceType: r6i.32xlarge
      MinCount: 0
      MaxCount: 8
      SpotPrice: 6.4899 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    Networking:
      SubnetIds:
      - subnet-087a4872d0c34e642
    CustomActions:
      OnNodeConfigured:
        Script: s3://lsmc-dayoa-omics-analysis-us-west-2/cluster_boot_config/post_install_ubuntu_combined.sh
        Args:
        - us-west-2
        - lsmc-dayoa-omics-analysis-us-west-2
        - na
        - na
    Iam:
      S3Access:
      - BucketName: lsmc-dayoa-omics-analysis-us-west-2
        EnableWriteAccess: false
      AdditionalIamPolicies:
      - Policy: arn:aws:iam::108782052779:policy/pclusterTagsAndBudget
      - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  - Name: i192
    CapacityType: SPOT
    AllocationStrategy: price-capacity-optimized
    ComputeResources:
    - Name: all
      Instances:
      - InstanceType: c7i.48xlarge
      - InstanceType: c7i.metal-48xl
      - InstanceType: m7i.metal-48xl
      - InstanceType: m7i.48xlarge
      - InstanceType: r7i.48xlarge
      - InstanceType: r7i.metal-48xl
      MinCount: 0
      MaxCount: 14
      SpotPrice: 7.9016 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    Networking:
      SubnetIds:
      - subnet-087a4872d0c34e642
    CustomActions:
      OnNodeConfigured:
        Script: s3://lsmc-dayoa-omics-analysis-us-west-2/cluster_boot_config/post_install_ubuntu_combined.sh
        Args:
        - us-west-2
        - lsmc-dayoa-omics-analysis-us-west-2
        - na
        - na
    Iam:
      S3Access:
      - BucketName: lsmc-dayoa-omics-analysis-us-west-2
        EnableWriteAccess: false
      AdditionalIamPolicies:
      - Policy: arn:aws:iam::108782052779:policy/pclusterTagsAndBudget
      - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  - Name: i192mem
    CapacityType: SPOT
    AllocationStrategy: price-capacity-optimized
    ComputeResources:
    - Name: all
      Instances:
      - InstanceType: m7i.metal-48xl
      - InstanceType: m7i.48xlarge
      - InstanceType: r7i.48xlarge
      - InstanceType: r7i.metal-48xl
      MinCount: 0
      MaxCount: 14
      SpotPrice: 8.4263 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    Networking:
      SubnetIds:
      - subnet-087a4872d0c34e642
    CustomActions:
      OnNodeConfigured:
        Script: s3://lsmc-dayoa-omics-analysis-us-west-2/cluster_boot_config/post_install_ubuntu_combined.sh
        Args:
        - us-west-2
        - lsmc-dayoa-omics-analysis-us-west-2
        - na
        - na
    Iam:
      S3Access:
      - BucketName: lsmc-dayoa-omics-analysis-us-west-2
        EnableWriteAccess: false
      AdditionalIamPolicies:
      - Policy: arn:aws:iam::108782052779:policy/pclusterTagsAndBudget
      - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  - Name: i192bigmem
    CapacityType: SPOT
    AllocationStrategy: price-capacity-optimized
    ComputeResources:
    - Name: all
      Instances:
      - InstanceType: r7i.48xlarge
      - InstanceType: r7i.metal-48xl
      MinCount: 0
      MaxCount: 14
      SpotPrice: 9.0848 # Calculated using (median spot price).
      Networking:
        PlacementGroup:
          Enabled: false
      Efa:
        Enabled: false
    Networking:
      SubnetIds:
      - subnet-087a4872d0c34e642
    CustomActions:
      OnNodeConfigured:
        Script: s3://lsmc-dayoa-omics-analysis-us-west-2/cluster_boot_config/post_install_ubuntu_combined.sh
        Args:
        - us-west-2
        - lsmc-dayoa-omics-analysis-us-west-2
        - na
        - na
    Iam:
      S3Access:
      - BucketName: lsmc-dayoa-omics-analysis-us-west-2
        EnableWriteAccess: false
      AdditionalIamPolicies:
      - Policy: arn:aws:iam::108782052779:policy/pclusterTagsAndBudget
      - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
Monitoring:
  DetailedMonitoring: false
  Logs:
    CloudWatch:
      Enabled: true
      RetentionInDays: 3  # must be 0,1,3,5,7,14,30,60,90...
SharedStorage:  # This is the local FS which should not be kept idle for long
- MountDir: /fsx    # The cost of this will be roughly $22.93 per day for 4.2Tb, spin down when not in use
  Name: fsx-dyoa-smn12-go     # WARNING, EDIT NAME WILL DEL EXISTING DATA
  StorageType: FsxLustre
  FsxLustreSettings:
    ImportPath: s3://lsmc-dayoa-omics-analysis-us-west-2/data/
    StorageCapacity: 4800    #  4.2TB ~  $22.93/day or $0.921/hr
    DeploymentType: SCRATCH_2
    AutoImportPolicy: NEW_CHANGED_DELETED
    DeletionPolicy: Delete    # Set to true to keep the FSX after the cluster is deleted
Tags:  # TAGs necessary for per-user/project/job cost tracking 
- Key: aws-parallelcluster-username
  Value: daylily-daylily-service
- Key: aws-parallelcluster-jobid
  Value: aws_profile-daylily-service-lsmc
- Key: aws-parallelcluster-project
  Value: da-us-west-2d-dyoa-smn12-go
- Key: aws-parallelcluster-clustername
  Value: dyoa-smn12-go
- Key: aws-parallelcluster-enforce-budget
  Value: skip
- Key: aws-parallelcluster-daylily-git-deets
  Value: daylily-ephemeral-cluster-main-63b0b38996be3f51a63fe150f0e14f4227a496d2-0.7.375
DevSettings:
  Timeouts:
    HeadNodeBootstrapTimeout: 3600
    ComputeNodeBootstrapTimeout: 3600
...
