#!/usr/bin/env python3
"""Launch the Daylily workset monitoring web API and dashboard."""

from __future__ import annotations

import argparse
import logging
import sys
from pathlib import Path
from typing import Optional, Sequence

import uvicorn

# Add parent directory to path for imports
if __package__ in {None, ""}:
    sys.path.insert(0, str(Path(__file__).resolve().parents[1]))

from daylib.workset_api import create_app
from daylib.workset_state_db import WorksetStateDB
from daylib.workset_scheduler import WorksetScheduler

LOGGER = logging.getLogger("daylily.workset_api.cli")


def parse_args(argv: Optional[Sequence[str]] = None) -> argparse.Namespace:
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Launch Daylily workset monitoring web API",
    )
    parser.add_argument(
        "--table-name",
        default="daylily-worksets",
        help="DynamoDB table name for workset state",
    )
    parser.add_argument(
        "--region",
        default="us-west-2",
        help="AWS region",
    )
    parser.add_argument(
        "--profile",
        help="AWS profile name",
    )
    parser.add_argument(
        "--host",
        default="0.0.0.0",
        help="Host to bind to",
    )
    parser.add_argument(
        "--port",
        type=int,
        default=8001,
        help="Port to bind to",
    )
    parser.add_argument(
        "--enable-scheduler",
        action="store_true",
        help="Enable scheduler endpoints",
    )
    parser.add_argument(
        "--create-table",
        action="store_true",
        help="Create DynamoDB table if it doesn't exist",
    )
    parser.add_argument(
        "--reload",
        action="store_true",
        help="Enable auto-reload for development",
    )
    parser.add_argument(
        "--verbose",
        action="store_true",
        help="Enable debug logging",
    )
    parser.add_argument(
        "--control-bucket",
        default=None,
        help="S3 control bucket (monitor bucket) for workset registration. "
             "Can also be set via DAYLILY_CONTROL_BUCKET or DAYLILY_MONITOR_BUCKET env vars",
    )
    parser.add_argument(
        "--control-prefix",
        default="daylily_monitoring/active_worksets/",
        help="S3 prefix within control bucket for worksets (default: daylily_monitoring/active_worksets/)",
    )
    return parser.parse_args(argv)


def configure_logging(verbose: bool) -> None:
    """Configure logging."""
    level = logging.DEBUG if verbose else logging.INFO
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    )


def main(argv: Optional[Sequence[str]] = None) -> int:
    """Main entry point."""
    import os
    from daylib.workset_integration import WorksetIntegration

    args = parse_args(argv)
    configure_logging(args.verbose)

    # Initialize state database
    LOGGER.info("Initializing workset state database: %s", args.table_name)
    state_db = WorksetStateDB(
        table_name=args.table_name,
        region=args.region,
        profile=args.profile,
    )

    if args.create_table:
        LOGGER.info("Creating DynamoDB table if needed...")
        state_db.create_table_if_not_exists()

    # Initialize scheduler if enabled
    scheduler = None
    if args.enable_scheduler:
        LOGGER.info("Enabling scheduler")
        scheduler = WorksetScheduler(state_db)

    # Initialize integration layer with control bucket
    integration = None
    control_bucket = args.control_bucket or os.getenv("DAYLILY_CONTROL_BUCKET") or os.getenv("DAYLILY_MONITOR_BUCKET")
    if control_bucket:
        LOGGER.info("Initializing integration layer with control bucket: %s", control_bucket)
        try:
            integration = WorksetIntegration(
                state_db=state_db,
                bucket=control_bucket,
                prefix=args.control_prefix,
                region=args.region,
                profile=args.profile,
            )
            LOGGER.info("Integration layer initialized successfully")
        except Exception as e:
            LOGGER.warning("Failed to initialize integration layer: %s", e)
    else:
        LOGGER.warning("No control bucket configured. Set DAYLILY_CONTROL_BUCKET or use --control-bucket")

    # Create FastAPI app
    app = create_app(state_db, scheduler, integration=integration)

    # Run server
    LOGGER.info("Starting API server on %s:%d", args.host, args.port)
    uvicorn.run(
        app,
        host=args.host,
        port=args.port,
        reload=args.reload,
        log_level="debug" if args.verbose else "info",
    )

    return 0


if __name__ == "__main__":
    sys.exit(main())

