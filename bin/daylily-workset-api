#!/usr/bin/env python3
"""Launch the Daylily workset monitoring web API and dashboard."""

from __future__ import annotations

import argparse
import logging
import os
import sys
from pathlib import Path
from typing import Optional, Sequence

import uvicorn

# Add parent directory to path for imports
if __package__ in {None, ""}:
    sys.path.insert(0, str(Path(__file__).resolve().parents[1]))

from daylib.config import normalize_bucket_name
from daylib.workset_api import create_app
from daylib.workset_state_db import WorksetStateDB
from daylib.workset_scheduler import WorksetScheduler

LOGGER = logging.getLogger("daylily.workset_api.cli")


def _str_to_bool(val: str) -> bool:
    """Convert string to boolean, handling common truthy values."""
    return val.lower() in ("true", "1", "yes", "on")


def parse_args(argv: Optional[Sequence[str]] = None) -> argparse.Namespace:
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Launch Daylily workset monitoring web API",
    )
    parser.add_argument(
        "--table-name",
        default="daylily-worksets",
        help="DynamoDB table name for workset state",
    )
    parser.add_argument(
        "--region",
        default="us-west-2",
        help="AWS region",
    )
    parser.add_argument(
        "--profile",
        help="AWS profile name",
    )
    parser.add_argument(
        "--host",
        default="0.0.0.0",
        help="Host to bind to",
    )
    parser.add_argument(
        "--port",
        type=int,
        default=8001,
        help="Port to bind to",
    )
    parser.add_argument(
        "--enable-scheduler",
        action="store_true",
        help="Enable scheduler endpoints",
    )
    parser.add_argument(
        "--create-table",
        action="store_true",
        default=True,
        help="Create DynamoDB tables if they don't exist (default: True)",
    )
    parser.add_argument(
        "--no-create-table",
        action="store_false",
        dest="create_table",
        help="Don't create DynamoDB tables automatically",
    )
    parser.add_argument(
        "--reload",
        action="store_true",
        help="Enable auto-reload for development",
    )
    parser.add_argument(
        "--verbose",
        action="store_true",
        help="Enable debug logging",
    )
    parser.add_argument(
        "--control-bucket",
        default=None,
        help="S3 control bucket (monitor bucket) for workset registration. "
             "Can also be set via DAYLILY_CONTROL_BUCKET or DAYLILY_MONITOR_BUCKET env vars",
    )
    parser.add_argument(
        "--control-prefix",
        default="daylily_monitoring/active_worksets/",
        help="S3 prefix within control bucket for worksets (default: daylily_monitoring/active_worksets/)",
    )
    return parser.parse_args(argv)


def configure_logging(verbose: bool) -> None:
    """Configure logging."""
    level = logging.DEBUG if verbose else logging.INFO
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    )


def main(argv: Optional[Sequence[str]] = None) -> int:
    """Main entry point."""
    from daylib.workset_integration import WorksetIntegration
    from daylib.ursa_config import get_ursa_config

    args = parse_args(argv)
    configure_logging(args.verbose)

    # Load UrsaConfig for centralized settings
    ursa_config = get_ursa_config()

    # Determine DynamoDB region: CLI arg > UrsaConfig > default
    # If --region was explicitly passed (not the default), use it
    # Otherwise, prefer UrsaConfig's dynamo_db_region
    if args.region != "us-west-2":
        # User explicitly specified a different region via CLI
        dynamo_region = args.region
        LOGGER.info("Using DynamoDB region from CLI: %s", dynamo_region)
    else:
        # Use UrsaConfig (which has env var override and default fallback)
        dynamo_region = ursa_config.get_effective_dynamo_db_region()
        source = ursa_config.get_value_source("dynamo_db_region")
        LOGGER.info("Using DynamoDB region from %s: %s", source if source != "not set" else "default", dynamo_region)

    # Initialize state database
    LOGGER.info("Initializing workset state database: %s (region: %s)", args.table_name, dynamo_region)
    state_db = WorksetStateDB(
        table_name=args.table_name,
        region=dynamo_region,
        profile=args.profile,
    )

    if args.create_table:
        LOGGER.info("Creating DynamoDB table if needed...")
        state_db.create_table_if_not_exists()

    # Initialize scheduler if enabled
    scheduler = None
    if args.enable_scheduler:
        LOGGER.info("Enabling scheduler")
        scheduler = WorksetScheduler(state_db)

    # Initialize integration layer with control bucket
    integration = None
    raw_bucket = args.control_bucket or os.getenv("DAYLILY_CONTROL_BUCKET") or os.getenv("DAYLILY_MONITOR_BUCKET")
    control_bucket = normalize_bucket_name(raw_bucket)
    if control_bucket:
        LOGGER.info("Initializing integration layer with control bucket: %s", control_bucket)
        try:
            integration = WorksetIntegration(
                state_db=state_db,
                bucket=control_bucket,
                prefix=args.control_prefix,
                region=args.region,
                profile=args.profile,
            )
            LOGGER.info("Integration layer initialized successfully")
        except Exception as e:
            LOGGER.warning("Failed to initialize integration layer: %s", e)
    else:
        LOGGER.warning("No control bucket configured. Set DAYLILY_CONTROL_BUCKET or use --control-bucket")

    # Initialize CustomerManager for user registration and management
    customer_manager = None
    try:
        from daylib.workset_customer import CustomerManager
        customer_manager = CustomerManager(
            region=args.region,
            profile=args.profile,
        )
        # Always try to create the customer table if it doesn't exist
        try:
            customer_manager.create_customer_table_if_not_exists()
            LOGGER.info("CustomerManager initialized (table: %s)", customer_manager.customer_table_name)
        except Exception as table_err:
            LOGGER.warning("Could not verify/create customer table: %s", table_err)
            # Still keep the customer_manager - the table might exist
            LOGGER.info("CustomerManager initialized (table: %s, may need manual creation)", customer_manager.customer_table_name)
    except Exception as e:
        LOGGER.warning("Failed to initialize CustomerManager: %s", e)
        import traceback
        LOGGER.debug("CustomerManager init traceback: %s", traceback.format_exc())

    # Check if authentication is enabled via environment variable
    enable_auth = _str_to_bool(os.getenv("DAYLILY_ENABLE_AUTH", "false"))
    cognito_auth = None

    if enable_auth:
        # Import CognitoAuth only when needed
        try:
            from daylib.workset_auth import CognitoAuth
        except ImportError:
            LOGGER.error(
                "Authentication enabled but python-jose not installed. "
                "Install with: pip install 'python-jose[cryptography]'"
            )
            return 1

        # Get Cognito configuration from ursa config (with env var override)
        from daylib.ursa_config import get_ursa_config
        ursa_config = get_ursa_config()

        # Env vars take precedence, then ursa config
        user_pool_id = (
            os.getenv("COGNITO_USER_POOL_ID")
            or ursa_config.cognito_user_pool_id
        )
        app_client_id = (
            os.getenv("COGNITO_CLIENT_ID")
            or os.getenv("COGNITO_APP_CLIENT_ID")
            or ursa_config.cognito_app_client_id
        )
        cognito_region = (
            os.getenv("COGNITO_REGION")
            or ursa_config.cognito_region
            or args.region
        )

        if not user_pool_id or not app_client_id:
            LOGGER.error(
                "Authentication enabled but Cognito not configured. "
                "Set COGNITO_USER_POOL_ID and COGNITO_APP_CLIENT_ID in environment "
                "or ~/.ursa/ursa-config.yaml"
            )
            return 1

        source_pool = ursa_config.get_value_source("cognito_user_pool_id")
        source_client = ursa_config.get_value_source("cognito_app_client_id")
        LOGGER.info(
            "Initializing Cognito authentication (pool: %s [%s], client: [%s])",
            user_pool_id, source_pool, source_client
        )

        # Get settings for domain whitelist validation
        from daylib.config import get_settings
        settings = get_settings()
        cognito_auth = CognitoAuth(
            region=cognito_region,
            user_pool_id=user_pool_id,
            app_client_id=app_client_id,
            profile=args.profile,
            settings=settings,
        )
        LOGGER.info("Cognito authentication initialized successfully")
    else:
        LOGGER.info("Authentication disabled (set DAYLILY_ENABLE_AUTH=true to enable)")

    # Initialize FileRegistry for file management API
    file_registry = None
    try:
        from daylib.file_registry import FileRegistry
        file_registry = FileRegistry(
            region=args.region,
            profile=args.profile,
        )
        # Ensure the tables exist
        try:
            file_registry.create_tables_if_not_exist()
            LOGGER.info("FileRegistry initialized (tables: %s, %s, %s)",
                        file_registry.files_table_name,
                        file_registry.filesets_table_name,
                        file_registry.file_workset_usage_table_name)
        except Exception as table_err:
            LOGGER.warning("Could not verify/create file registry tables: %s", table_err)
    except Exception as e:
        LOGGER.warning("Failed to initialize FileRegistry: %s", e)
        import traceback
        LOGGER.debug("FileRegistry init traceback: %s", traceback.format_exc())

    # Create FastAPI app
    LOGGER.info("Creating FastAPI app with customer_manager=%s, file_registry=%s",
                "CONFIGURED" if customer_manager else "NONE",
                "CONFIGURED" if file_registry else "NONE")
    app = create_app(
        state_db,
        scheduler,
        integration=integration,
        cognito_auth=cognito_auth,
        customer_manager=customer_manager,
        enable_auth=enable_auth,
        file_registry=file_registry,
    )

    # Run server
    auth_status = "ENABLED" if enable_auth else "DISABLED"
    LOGGER.info("Starting API server on %s:%d (auth: %s)", args.host, args.port, auth_status)
    uvicorn.run(
        app,
        host=args.host,
        port=args.port,
        reload=args.reload,
        log_level="debug" if args.verbose else "info",
    )

    return 0


if __name__ == "__main__":
    sys.exit(main())

