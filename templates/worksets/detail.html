{% extends "base.html" %}
{% set active_page = 'worksets' %}

{% block title %}Workset {{ workset.workset_id[:12] }}... - Daylily Customer Portal{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <a href="/portal/worksets" class="text-muted mb-md d-block">
            <i class="fas fa-arrow-left"></i> Back to Worksets
        </a>
        <div class="d-flex justify-between align-center flex-wrap gap-lg">
            <div>
                <h1 class="page-title">
                    {{ workset.workset_name | default('Workset Details') }}
                    <span class="badge badge-{{ workset.state | lower | replace('_', '-') }} ml-md">
                        {{ workset.state }}
                    </span>
                </h1>
                <p class="page-subtitle">
                    <code>{{ workset.workset_id }}</code>
                    <button class="btn btn-outline btn-sm ml-sm" onclick="copyToClipboard('{{ workset.workset_id }}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </p>
            </div>
            <div class="page-actions" style="margin-top: 0;">
                {% if workset.state == 'in_progress' %}
                <button class="btn btn-outline" onclick="cancelWorkset('{{ workset.workset_id }}')">
                    <i class="fas fa-stop"></i> Cancel
                </button>
                {% elif workset.state == 'error' %}
                <button class="btn btn-primary" onclick="retryWorkset('{{ workset.workset_id }}')">
                    <i class="fas fa-redo"></i> Retry
                </button>
                {% elif workset.state == 'completed' %}
                <a href="/portal/worksets/{{ workset.workset_id }}/download" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download Results
                </a>
                {% elif workset.state == 'archived' %}
                <button class="btn btn-primary" onclick="restoreWorkset('{{ workset.workset_id }}')">
                    <i class="fas fa-undo"></i> Restore
                </button>
                {% endif %}
                <button class="btn btn-outline" onclick="refreshWorksetDetail()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>

                <!-- Archive/Delete buttons (not for archived or deleted worksets) -->
                {% if workset.state not in ['archived', 'deleted'] %}
                <button class="btn btn-outline" onclick="archiveWorkset('{{ workset.workset_id }}')" type="button">
                    <i class="fas fa-archive"></i> Archive
                </button>
                <button class="btn btn-outline" onclick="deleteWorkset('{{ workset.workset_id }}')" type="button" style="color: #ef4444; border-color: #ef4444;">
                    <i class="fas fa-trash"></i> Delete
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Progress Bar (for in-progress worksets) -->
    {% if workset.state == 'in_progress' %}
    <div class="card mb-lg">
        <div class="d-flex justify-between align-center mb-md">
            <span class="text-muted">Processing Progress</span>
            <span class="text-accent font-bold">{{ workset.progress | default(0) }}%</span>
        </div>
        <div class="progress" style="height: 12px;">
            <div class="progress-bar primary" style="width: {{ workset.progress | default(0) }}%"></div>
        </div>
        <div class="d-flex justify-between align-center mt-md" style="font-size: 0.875rem;">
            <p class="text-muted mb-0">
                <i class="fas fa-tasks"></i>
                Current Step: <strong>{{ workset.current_step | default('initializing') | replace('_', ' ') | title }}</strong>
            </p>
            {% if workset.cluster_name %}
            <p class="text-muted mb-0">
                <i class="fas fa-server"></i>
                Cluster: <code>{{ workset.cluster_name }}</code>
            </p>
            {% endif %}
        </div>
        {% if workset.started_at %}
        <p class="text-muted mt-sm mb-0" style="font-size: 0.8rem;">
            <i class="fas fa-clock"></i>
            Started: {{ workset.started_at }}
        </p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Error Alert -->
    {% if workset.state == 'error' and workset.error_message %}
    <div class="alert alert-error mb-lg">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <strong>Processing Error</strong>
            <p class="mb-0">{{ workset.error_message }}</p>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Content Grid -->
    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: var(--spacing-xl);">
        <!-- Left Column -->
        <div>
            <!-- Workset Info -->
            <div class="card">
                <h3 class="card-title">Workset Information</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label text-muted">Customer</label>
                        <p class="mb-0"><strong>{{ workset.customer_id | default('Unknown') }}</strong></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-muted">Pipeline Type</label>
                        <p class="mb-0">{{ workset.pipeline_type | default('germline') | title }}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-muted">Reference Genome</label>
                        <p class="mb-0">{{ workset.reference_genome | default('GRCh38') }}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-muted">Created</label>
                        <p class="mb-0">{{ workset.created_at | default('N/A') }}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-muted">Last Updated</label>
                        <p class="mb-0">{{ workset.updated_at | default('N/A') }}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-muted">S3 Location</label>
                        <p class="mb-0"><code>s3://{{ workset.s3_bucket }}/{{ workset.s3_prefix }}</code></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-muted">Priority</label>
                        <p class="mb-0">{{ workset.priority | default('normal') | title }}</p>
                    </div>
                    {% if workset.cluster_name %}
                    <div class="form-group">
                        <label class="form-label text-muted">Cluster</label>
                        <p class="mb-0"><code>{{ workset.cluster_name }}</code></p>
                    </div>
                    {% endif %}
                    {% if workset.started_at %}
                    <div class="form-group">
                        <label class="form-label text-muted">Started</label>
                        <p class="mb-0">{{ workset.started_at }}</p>
                    </div>
                    {% endif %}
                    {% if workset.finished_at %}
                    <div class="form-group">
                        <label class="form-label text-muted">Finished</label>
                        <p class="mb-0">{{ workset.finished_at }}</p>
                    </div>
                    {% endif %}
                    {% if workset.lock_owner %}
                    <div class="form-group">
                        <label class="form-label text-muted">Lock Owner</label>
                        <p class="mb-0"><code style="font-size: 0.75rem;">{{ workset.lock_owner }}</code></p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Samples -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Samples ({{ workset.samples | length if workset.samples else 0 }})</h3>
                </div>
                <div class="table-container" style="box-shadow: none; max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sample ID</th>
                                <th>Status</th>
                                <th>R1 File</th>
                                <th>R2 File</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if workset.samples %}
                            {% for sample in workset.samples %}
                            <tr>
                                <td>{{ sample.sample_id }}</td>
                                <td><span class="badge badge-{{ sample.status | lower }}">{{ sample.status }}</span></td>
                                <td><code style="font-size: 0.75rem;">{{ sample.r1_file | default('N/A') }}</code></td>
                                <td><code style="font-size: 0.75rem;">{{ sample.r2_file | default('N/A') }}</code></td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No samples found</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pipeline Status (Live from Headnode) -->
            <div class="card" id="pipeline-status-card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> Pipeline Status</h3>
                    <button class="btn btn-outline btn-sm" onclick="refreshPipelineStatus('{{ workset.workset_id }}')" title="Refresh status">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="pipeline-status-content">
                    <div class="text-center text-muted py-md">
                        <i class="fas fa-spinner fa-spin"></i> Loading pipeline status...
                    </div>
                </div>
            </div>

            <!-- Processing Logs -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-scroll"></i> Processing Logs</h3>
                    <div class="d-flex gap-sm">
                        <button class="btn btn-outline btn-sm" onclick="downloadLogs('{{ workset.workset_id }}')" title="Download state history">
                            <i class="fas fa-download"></i> History
                        </button>
                        <button class="btn btn-outline btn-sm" id="download-snakemake-btn" onclick="downloadSnakemakeLogs('{{ workset.workset_id }}')" title="Download Snakemake logs" style="display: none;">
                            <i class="fas fa-file-alt"></i> Snakemake
                        </button>
                    </div>
                </div>
                <div class="code-block" style="max-height: 300px; overflow-y: auto;">
                    <pre id="workset-logs">{{ workset.logs | default('No logs available yet...') }}</pre>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div>
            <!-- Cost Summary -->
            <div class="card">
                <h3 class="card-title"><i class="fas fa-dollar-sign"></i> Cost Summary</h3>
                <div class="stat-value text-accent">${{ "%.2f"|format(workset.cost_usd | default(0)) }}</div>
                <div class="stat-label mb-lg">Total Cost</div>
                
                <dl style="margin: 0;">
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Compute</dt>
                        <dd>${{ "%.2f"|format(workset.compute_cost | default(0)) }}</dd>
                    </div>
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Storage</dt>
                        <dd>${{ "%.2f"|format(workset.storage_cost | default(0)) }}</dd>
                    </div>
                    <div class="d-flex justify-between">
                        <dt class="text-muted">Data Transfer</dt>
                        <dd>${{ "%.2f"|format(workset.transfer_cost | default(0)) }}</dd>
                    </div>
                </dl>
            </div>
            
            <!-- Resource Usage -->
            <div class="card">
                <h3 class="card-title"><i class="fas fa-server"></i> Resource Usage</h3>
                <dl style="margin: 0;">
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">vCPU Hours</dt>
                        <dd>{{ workset.vcpu_hours | default(0) }}</dd>
                    </div>
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Memory (GB-hours)</dt>
                        <dd>{{ workset.memory_gb_hours | default(0) }}</dd>
                    </div>
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Storage Used</dt>
                        <dd>{{ "%.1f"|format(workset.storage_gb | default(0)) }} GB</dd>
                    </div>
                    <div class="d-flex justify-between">
                        <dt class="text-muted">Duration</dt>
                        <dd>{{ workset.duration | default('N/A') }}</dd>
                    </div>
                </dl>
            </div>

            <!-- Execution Environment -->
            {% if workset.execution_cluster_name or workset.execution_s3_bucket %}
            <div class="card">
                <h3 class="card-title"><i class="fas fa-cloud"></i> Execution Environment</h3>
                <dl style="margin: 0;">
                    {% if workset.execution_cluster_name %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Cluster</dt>
                        <dd><code>{{ workset.execution_cluster_name }}</code></dd>
                    </div>
                    {% endif %}
                    {% if workset.execution_cluster_region %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Region</dt>
                        <dd>{{ workset.execution_cluster_region }}</dd>
                    </div>
                    {% endif %}
                    {% if is_admin and workset.execution_headnode_ip %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Headnode IP</dt>
                        <dd><code>{{ workset.execution_headnode_ip }}</code></dd>
                    </div>
                    {% endif %}
                    {% if workset.execution_s3_bucket %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Output Bucket</dt>
                        <dd><code>{{ workset.execution_s3_bucket }}</code></dd>
                    </div>
                    {% endif %}
                    {% if workset.execution_s3_prefix %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Output Prefix</dt>
                        <dd style="word-break: break-all;"><code style="font-size: 0.75rem;">{{ workset.execution_s3_prefix }}</code></dd>
                    </div>
                    {% endif %}
                    {% if workset.execution_started_at %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Execution Started</dt>
                        <dd>{{ workset.execution_started_at }}</dd>
                    </div>
                    {% endif %}
                    {% if workset.execution_ended_at %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Execution Ended</dt>
                        <dd>{{ workset.execution_ended_at }}</dd>
                    </div>
                    {% endif %}
                </dl>
                {% if is_admin and workset.execution_headnode_ip and workset.execution_cluster_region %}
                <div class="mt-md" style="border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                    <span class="text-muted text-xs">SSH Command</span>
                    <div class="code-block mt-sm" style="font-size: 0.75rem; padding: 0.5rem;">
                        <code>ssh -i ~/.ssh/lsmc-omics-{{ workset.execution_cluster_region }}.pem ubuntu@{{ workset.execution_headnode_ip }}</code>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- DynamoDB Metrics (if available) -->
            {% if workset.metrics %}
            <div class="card">
                <h3 class="card-title"><i class="fas fa-chart-line"></i> Processing Metrics</h3>
                <dl style="margin: 0;">
                    {% if workset.metrics.samples_processed is defined %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Samples Processed</dt>
                        <dd>{{ workset.metrics.samples_processed }}</dd>
                    </div>
                    {% endif %}
                    {% if workset.metrics.bytes_transferred is defined %}
                    <div class="d-flex justify-between mb-sm">
                        <dt class="text-muted">Data Transferred</dt>
                        <dd>{{ "%.2f"|format(workset.metrics.bytes_transferred / 1073741824) }} GB</dd>
                    </div>
                    {% endif %}
                    {% if workset.metrics.step_durations is defined %}
                    <div class="mb-sm">
                        <dt class="text-muted mb-sm">Step Durations</dt>
                        {% for step, duration in workset.metrics.step_durations.items() %}
                        <div class="d-flex justify-between" style="font-size: 0.85rem; padding-left: 1rem;">
                            <span>{{ step | replace('_', ' ') | title }}</span>
                            <span>{{ duration }}s</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </dl>
            </div>
            {% endif %}

            <!-- Results (if completed) -->
            {% if workset.state == 'completed' %}
            <div class="card">
                <h3 class="card-title"><i class="fas fa-file-archive"></i> Results</h3>
                <ul class="list-unstyled">
                    <li class="mb-md">
                        <a href="/portal/worksets/{{ workset.workset_id }}/results/vcf" class="d-flex align-center gap-sm">
                            <i class="fas fa-dna text-accent"></i> VCF Files
                        </a>
                    </li>
                    <li class="mb-md">
                        <a href="/portal/worksets/{{ workset.workset_id }}/results/bam" class="d-flex align-center gap-sm">
                            <i class="fas fa-align-left text-accent"></i> BAM Files
                        </a>
                    </li>
                    <li class="mb-md">
                        <a href="/portal/worksets/{{ workset.workset_id }}/results/qc" class="d-flex align-center gap-sm">
                            <i class="fas fa-chart-bar text-accent"></i> QC Reports
                        </a>
                    </li>
                    <li>
                        <a href="/portal/worksets/{{ workset.workset_id }}/results/all" class="d-flex align-center gap-sm">
                            <i class="fas fa-download text-accent"></i> Download All
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/worksets.js?v={{ cache_bust | default('1') }}"></script>
<script>
// Pipeline status display
const worksetId = '{{ workset.workset_id }}';
const customerId = window.DaylilyConfig?.customerId;

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${mins}m`;
}

function renderPipelineStatus(status) {
    const container = document.getElementById('pipeline-status-content');
    if (!status) {
        container.innerHTML = `
            <div class="text-muted py-sm" style="padding: 1rem;">
                <i class="fas fa-info-circle"></i> Pipeline status unavailable
                <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                    Status is only available when a cluster is running and SSH access is configured.
                </div>
            </div>`;
        return;
    }

    if (status.error_message) {
        container.innerHTML = `
            <div class="text-warning py-sm" style="padding: 1rem;">
                <i class="fas fa-exclamation-triangle"></i> ${status.error_message}
            </div>`;
        return;
    }

    const runningBadge = status.is_running
        ? '<span class="badge badge-success"><i class="fas fa-play"></i> Running</span>'
        : '<span class="badge badge-secondary"><i class="fas fa-stop"></i> Not Running</span>';

    const progressBar = status.steps_total > 0 ? `
        <div style="margin: 1rem 0;">
            <div class="d-flex justify-between mb-sm">
                <span>Progress: ${status.steps_completed} / ${status.steps_total} steps</span>
                <span>${status.percent_complete.toFixed(1)}%</span>
            </div>
            <div style="background: var(--bg-tertiary); border-radius: 4px; height: 8px; overflow: hidden;">
                <div style="background: var(--accent); height: 100%; width: ${status.percent_complete}%; transition: width 0.3s;"></div>
            </div>
        </div>` : '';

    const currentRule = status.current_rule
        ? `<div class="mb-sm"><strong>Current Rule:</strong> <code>${status.current_rule}</code></div>`
        : '';

    const errorsSection = status.errors && status.errors.length > 0 ? `
        <div class="mt-md" style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <strong class="text-danger"><i class="fas fa-exclamation-circle"></i> Errors (${status.errors.length}):</strong>
            <div class="code-block mt-sm" style="max-height: 150px; overflow-y: auto; font-size: 0.8rem;">
                <pre style="margin: 0; white-space: pre-wrap;">${status.errors.join('\n')}</pre>
            </div>
        </div>` : '';

    // Show download button if log files exist
    if (status.log_files && status.log_files.length > 0) {
        document.getElementById('download-snakemake-btn').style.display = 'inline-flex';
    }

    container.innerHTML = `
        <div style="padding: 1rem;">
            <div class="d-flex justify-between align-center mb-md">
                ${runningBadge}
                <span class="text-muted" style="font-size: 0.85rem;">
                    <i class="fas fa-clock"></i> ${formatDuration(status.duration_seconds)}
                    &nbsp;|&nbsp;
                    <i class="fas fa-hdd"></i> ${formatBytes(status.storage_bytes)}
                </span>
            </div>
            ${progressBar}
            ${currentRule}
            ${status.log_files && status.log_files.length > 0 ? `
                <div class="text-muted" style="font-size: 0.85rem;">
                    <i class="fas fa-file-alt"></i> ${status.log_files.length} log file(s) available
                </div>` : ''}
            ${errorsSection}
        </div>`;
}

async function loadPipelineStatus() {
    if (!customerId) {
        renderPipelineStatus(null);
        return;
    }
    try {
        const response = await DaylilyAPI.worksets.getLogs(customerId, worksetId);
        renderPipelineStatus(response.pipeline_status);

        // Also update state history if available
        if (response.state_history && response.state_history.length > 0) {
            const logsEl = document.getElementById('workset-logs');
            if (logsEl) {
                const historyText = response.state_history.map(h =>
                    `[${h.timestamp || 'N/A'}] ${h.state || h.new_state || 'unknown'}: ${h.reason || ''}`
                ).join('\n');
                logsEl.textContent = historyText || 'No state history available';
            }
        }
    } catch (error) {
        console.error('Failed to load pipeline status:', error);
        renderPipelineStatus({ error_message: 'Failed to fetch status: ' + error.message });
    }
}

async function refreshPipelineStatus(wsId) {
    const container = document.getElementById('pipeline-status-content');
    container.innerHTML = `
        <div class="text-center text-muted py-md">
            <i class="fas fa-spinner fa-spin"></i> Refreshing...
        </div>`;
    await loadPipelineStatus();
}

async function downloadSnakemakeLogs(wsId) {
    if (!customerId) return;
    try {
        const response = await DaylilyAPI.worksets.getLogs(customerId, wsId);
        if (response.pipeline_status && response.pipeline_status.recent_log_lines) {
            const content = response.pipeline_status.recent_log_lines.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workset-${wsId}-snakemake.log`;
            a.click();
            URL.revokeObjectURL(url);
        } else {
            showToast('warning', 'No Logs', 'No Snakemake log content available');
        }
    } catch (error) {
        showToast('error', 'Download Failed', error.message);
    }
}

// Load pipeline status on page load
document.addEventListener('DOMContentLoaded', loadPipelineStatus);

// Auto-refresh for in-progress worksets
{% if workset.state == 'in_progress' %}
setInterval(refreshWorksetDetail, 30000);
{% endif %}
</script>
{% endblock %}

